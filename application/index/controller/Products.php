<?php

namespace app\index\controller;

use app\common\controller\Frontend;

class Products extends Frontend
{

    protected $noNeedLogin = '*';
    protected $noNeedRight = '*';
    protected $layout = '';

    /**
     * 产品中心
     * @return string
     * @throws \think\Exception
     */
    public function index()
    {
        $image = getImage('images, link', 3, 1);

        // 当前模块
        $subMenu = getArticleCategoryDetail('link', '/'.$this->request->pathinfo(), 'id, top_title, top_info');

        // 二级模块
        $childArticleCategoryList = getArticleCategoryList('parent_id', $subMenu['id'], 'id, top_image, top_title, top_title_en, article_category_image, link, article_category_name',10);

        $this->assign('childArticleCategoryList', $childArticleCategoryList);
        $this->assign('image', $image);
        $this->assign('subMenu', $subMenu);
        $this->assign('sign', 'products');
        return $this->view->fetch();
    }

    /**
     * 商品列表
     * @param int $id
     * @return string
     * @throws \think\Exception
     */
    public function list($id=0)
    {
        // 当前模块
        $subMenu = getArticleCategoryDetail('id', $id, 'id, link, article_category_name, parent_id, article_category_enname');

        $ids = $subMenu['id'];

        // 上级模块
        $parentMenu = getArticleCategoryDetail('id', $subMenu['parent_id'], 'id, link, article_category_name, parent_id');

        // 顶级模块
        $topParentMenu = [];
        if(!empty($parentMenu['parent_id'])) $topParentMenu = getArticleCategoryDetail('id', $parentMenu['parent_id'], 'id, link, article_category_name, parent_id');

        $image = getImage('images, link', $id, 1);

        // 查询模块下的子模块
        $childCategoryIds = db('article_category')
            ->where('parent_id', '=', $subMenu['id'])
            ->value('GROUP_CONCAT(id) as ids');

        if(!empty($childCategoryIds)) $ids .=','.$childCategoryIds;

        $productList = db('goods')
            ->where('article_category_id', 'in', $ids)
            ->field('id, title, images, article_category_id')
            ->order('weigh desc, id desc')
            ->select();

        foreach($productList as &$v){
            $v['images'] = explode(',', $v['images']);
            $v['article_category_name'] = db('article_category')
                ->where('id', '=', $v['article_category_id'])
                ->value('article_category_name');
        }
        unset($v);

        $this->assign('subMenu', $subMenu);
        $this->assign('productList', $productList);
        $this->assign('image', $image);
        $this->assign('parentMenu', $parentMenu);
        $this->assign('topParentMenu', $topParentMenu);
        $this->assign('sign', 'products');
        return $this->view->fetch();
    }

    public function detail($id=0)
    {
        // 商品信息
        $productDetail = getProductDetail('id', $id, '*');
        if(!empty($productDetail)) $productDetail['images'] = explode(',', $productDetail['images']);

        // 商品上级模块信息
        $articleCategory = getArticleCategoryDetail('id', $productDetail['article_category_id'], 'id, parent_id, article_category_name, article_category_enname, link');

        $parentArticlaCategory_1 =[];
        $parentArticlaCategory_2 =[];
        $parentArticlaCategory_3 =[];

        // 顶级模块
        $topArticleCategory = [];
        $parentArticlaCategory_1 = $articleCategory;
        if(empty($articleCategory['parent_id']))
        {
            $topArticleCategory = $articleCategory;
        }
        else
        {
            $parentArticleCategory = getArticleCategoryDetail('id', $articleCategory['parent_id'], 'id, parent_id, article_category_name, article_category_enname, link');
            $parentArticlaCategory_2 = $parentArticleCategory;
            if(empty($parentArticleCategory['parent_id']))
            {
                $topArticleCategory = $parentArticleCategory;
            }
            else
            {
                $topArticleCategory = getArticleCategoryDetail('id', $parentArticleCategory['parent_id'], 'id, parent_id, article_category_name, article_category_enname, link');
                $parentArticlaCategory_3 = $topArticleCategory;
            }
        }


        // 查询子模块列表
        $articleCategoryList = getArticleCategoryList('parent_id', $topArticleCategory['id'], 'id, article_category_name, link');
        if(!empty($articleCategoryList))
        {
            $ids = implode(',', array_column($articleCategoryList, 'id'));
            $articleCategoryList_1 = db('article_category')
                ->where('parent_id', 'in', $ids)
                ->field('id, article_category_name, link')
                ->order('weigh desc, id desc')
                ->select();
            $articleCategoryList = array_merge($articleCategoryList, $articleCategoryList_1);
        }

        // 产品推荐
        $productList = db('goods')
            ->alias('a')
            ->join('article_category b','a.article_category_id = b.id')
            ->where('a.is_tuijian', '=', '1')
            ->order('a.weigh desc, a.id desc')
            ->field('a.id, a.title, a.images, a.article_category_id, b.article_category_name, a.is_tuijian')
            ->select();
        if(!empty($productList))
        {
            foreach($productList as &$v)
            {
                $v['images'] = explode(',', $v['images']);
            }
            unset($v);
        }

        $this->assign('productList', $productList);
        $this->assign('productDetail', $productDetail);
        $this->assign('topArticleCategory', $topArticleCategory);
        $this->assign('articleCategoryList', $articleCategoryList);
        $this->assign('parentArticlaCategory_1', $parentArticlaCategory_1);
        $this->assign('parentArticlaCategory_2', $parentArticlaCategory_2);
        $this->assign('parentArticlaCategory_3', $parentArticlaCategory_3);
        $this->assign('sign', 'products');
        return $this->view->fetch();
    }

}
