<?php

namespace app\index\controller;

use app\common\controller\Frontend;

class Index extends Frontend
{

    protected $noNeedLogin = '*';
    protected $noNeedRight = '*';
    protected $layout = '';

    public function index()
    {
        // 当前文章分类
        $subMenu = db('article_category')
            ->where('link', '/'.$this->request->pathinfo())
            ->find();

        $imageList = db('images')
            ->where('article_category_id', $subMenu['id'])
            ->order('weigh desc, id asc')
            ->limit(4)
            ->select();

        // 推荐产品模块
        $articleCategoryList = db('article_category')
            ->where('is_index', '=', 1)
            ->where('type', '=', '2')
            ->order('weigh desc, id desc')
            ->field('id, article_category_name, article_category_enname, article_category_image, link')
            ->limit(6)
            ->select();

        // 推荐案例
        $articleCategory = db('article_category')
            ->where('is_index', '=', 1)
            ->where('type', '=', '1')
            ->where('article_category_name', 'like', '%案例%')
            ->order('weigh desc, id desc')
            ->field('id, article_category_name, article_category_enname, link')
            ->limit(1)
            ->find();
        $articleList = db('article')
            ->alias('a')
            ->join('article_category b','a.article_category_id = b.id')
            ->where('b.is_index', '=', '1')
            ->where('b.type', '=', '1')
            ->where('a.is_index', '=', '1')
            ->field('a.id, a.title, a.info, a.image')
            ->limit(4)
            ->select();

        // 新闻资讯
        $articleList_1 = db('article')
            ->alias('a')
            ->join('article_category b','a.article_category_id = b.id')
            ->where('b.is_index', '=', '1')
            ->where('b.type', '=', '1')
            ->where('a.is_index', '=', '1')
            ->where('b.id', '<>', $articleCategory['id'])
            ->field('a.id, a.article_category_id, a.title, a.info, a.image, from_unixtime(a.createtime,"%Y") as year, from_unixtime(a.createtime,"%Y") as year, from_unixtime(a.createtime,"%m-%d") as month')
            ->limit(4)
            ->select();
        $articleCount = db('article')
            ->alias('a')
            ->join('article_category b','a.article_category_id = b.id')
            ->where('b.is_index', '=', '1')
            ->where('b.type', '=', '1')
            ->where('a.is_index', '=', '1')
            ->where('b.id', '<>', $articleCategory['id'])
            ->field('a.id, a.article_category_id, a.title, a.info, a.image, from_unixtime(a.createtime,"%Y") as year, from_unixtime(a.createtime,"%Y") as year, from_unixtime(a.createtime,"%m-%d") as month')
            ->count();

        $title= !empty($subMenu['seo_title']) ? $subMenu['seo_title'] : $this->site['seo_title'];
        $keywords = !empty($subMenu['seo_keywords']) ? $subMenu['seo_keywords'] : $this->site['seo_keywords'];
        $description = !empty($subMenu['seo_description']) ? $subMenu['seo_description'] : $this->site['seo_description'];
        $this->assign('title', $title);
        $this->assign('keywords', $keywords);
        $this->assign('description', $description);

        $this->assign('articleCount', $articleCount);
        $this->assign('articleList_1', $articleList_1);
        $this->assign('articleCategory', $articleCategory);
        $this->assign('articleList', $articleList);
        $this->assign('articleCategory', $articleCategory);
        $this->assign('articleCategoryList', $articleCategoryList);
        $this->assign('imageList', $imageList);
        $this->assign('sign', 'index');
        return $this->view->fetch();
    }

}
