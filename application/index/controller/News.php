<?php

namespace app\index\controller;

use app\common\controller\Frontend;

class News extends Frontend
{

    protected $noNeedLogin = '*';
    protected $noNeedRight = '*';
    protected $layout = '';

    // 新闻资讯
    public function index()
    {
        $image = getImage('images, link', 5, 1);

        $subMenu = getArticleCategoryDetail('link', '/'.$this->request->pathinfo(), 'id, top_title, top_title_en, link, article_category_name');

        // 查询子分类
        $childCategoryIds = db('article_category')
            ->where('parent_id', '=', $subMenu['id'])
            ->value('GROUP_CONCAT(id) as ids');

        $childCategoryList = getArticleCategoryList('parent_id', $subMenu['id'],'id, article_category_name, link', 4);
        $ids = $subMenu['id'].','.$childCategoryIds;

        $articleList = db('article')
            ->where('article_category_id', 'in', '('.$ids.')')
            ->field('id, title, FROM_UNIXTIME(createtime, "%Y-%m-%d") as createtimeText')
            ->order('weigh desc, id desc')
            ->paginate(10);


        $this->assign('subMenu', $subMenu);
        $this->assign('image', $image);
        $this->assign('childCategoryList', $childCategoryList);
        $this->assign('articleList', $articleList);
        $this->assign('sign', 'news');
        return $this->view->fetch();
    }

    // 行业新闻 公司动态
    public function list($id=0)
    {
        $image = getImage('images, link', 5, 1);

        // 当前子模块
        $articleCategoryDetail = getArticleCategoryDetail('id', $id, 'parent_id, id, article_category_name, link');

        // 父模块
        $subMenu = getArticleCategoryDetail('id', $articleCategoryDetail['parent_id'], 'id, top_title, top_title_en, link, article_category_name');

        // 根据父模块查询
        $childCategoryList = getArticleCategoryList('parent_id', $subMenu['id'],'id, article_category_name, link', 4);

        // 文章列表
        $articleList = db('article')
            ->where('article_category_id', '=', $id)
            ->field('id, title, FROM_UNIXTIME(createtime, "%Y-%m-%d") as createtimeText')
            ->order('weigh desc, id desc')
            ->paginate(10);

        $this->assign('subMenu', $subMenu);
        $this->assign('image', $image);
        $this->assign('childCategoryList', $childCategoryList);
        $this->assign('articleList', $articleList);
        $this->assign('articleCategoryDetail', $articleCategoryDetail);
        $this->assign('sign', 'news');
        return $this->view->fetch();
    }

    // 文章详情
    public function detail($id=0)
    {
        $articleDetail = getArticleDetail('id', $id, 'title, content, article_category_id');

        // 查询模块
        $articleCategoryDetail = getArticleCategoryDetail('id', $articleDetail['article_category_id'], 'link, article_category_name, parent_id');

        // 查询上级模块
        $parentArticleCategoryDetail= [];
        if(!empty($articleCategoryDetail['parent_id']))
        {
            $parentArticleCategoryDetail = getArticleCategoryDetail('id', $articleCategoryDetail['parent_id'], 'link, article_category_name, parent_id');
        }

        $this->assign('articleDetail', $articleDetail);
        $this->assign('articleCategoryDetail', $articleCategoryDetail);
        $this->assign('parentArticleCategoryDetail', $parentArticleCategoryDetail);
        $this->assign('sign', 'news');
        return $this->view->fetch();
    }

}