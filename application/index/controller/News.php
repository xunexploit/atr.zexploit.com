<?php

namespace app\index\controller;

use app\common\controller\Frontend;

class News extends Frontend
{

    protected $noNeedLogin = '*';
    protected $noNeedRight = '*';
    protected $layout = '';

    // 新闻资讯
    public function index()
    {
        // 当前文章分类
        $subMenu = db('article_category')
            ->where('link', '/'.$this->request->pathinfo())
            ->find();

        $image = db('images')
            ->where('article_category_id', $subMenu['id'])
            ->find();

        // 查询子分类ids
        $childCategoryIds = db('article_category')
            ->where('parent_id', '=', $subMenu['id'])
            ->value('GROUP_CONCAT(id) as ids');

        // 子分类里诶包
        $childCategoryList = db('article_category')->where('parent_id', '=', $subMenu['id'])->order('weigh desc, id asc')->limit(4)->select();
        $ids = $subMenu['id'].','.$childCategoryIds;

        $articleList = db('article')
            ->where('article_category_id', 'in', '('.$ids.')')
            ->field('id, title, title_en, FROM_UNIXTIME(createtime, "%Y-%m-%d") as createtimeText')
            ->order('weigh desc, id desc')
            ->paginate(10);

        $title= !empty($subMenu['seo_title']) ? $subMenu['seo_title'] : $this->site['seo_title'];
        $keywords = !empty($subMenu['seo_keywords']) ? $subMenu['seo_keywords'] : $this->site['seo_keywords'];
        $description = !empty($subMenu['seo_description']) ? $subMenu['seo_description'] : $this->site['seo_description'];
        $this->assign('title', $title);
        $this->assign('keywords', $keywords);
        $this->assign('description', $description);


        $this->assign('subMenu', $subMenu);
        $this->assign('image', $image);
        $this->assign('childCategoryList', $childCategoryList);
        $this->assign('articleList', $articleList);
        $this->assign('sign', 'news');
        return $this->view->fetch();
    }

    // 行业新闻 公司动态
    public function list($id=0)
    {
        // 当前子模块
        $articleCategoryDetail = db('article_category')->where('id', $id)->find();

        $image = db('images')->where('article_category_id', $id)->find();

        // 父模块
        $subMenu = db('article_category')->where('id', $articleCategoryDetail['parent_id'])->find();

        // 根据父模块查询
        $childCategoryList = db('article_category')->where('parent_id', $subMenu['id'])->order('weigh desc, id asc')->limit(4)->select();

        // 文章列表
        $articleList = db('article')
            ->where('article_category_id', '=', $id)
            ->field('id, title, title_en, FROM_UNIXTIME(createtime, "%Y-%m-%d") as createtimeText')
            ->order('weigh desc, id desc')
            ->paginate(10);

        $title= !empty($articleCategoryDetail['seo_title']) ? $articleCategoryDetail['seo_title'] : $this->site['seo_title'];
        $keywords = !empty($articleCategoryDetail['seo_keywords']) ? $articleCategoryDetail['seo_keywords'] : $this->site['seo_keywords'];
        $description = !empty($articleCategoryDetail['seo_description']) ? $articleCategoryDetail['seo_description'] : $this->site['seo_description'];
        $this->assign('title', $title);
        $this->assign('keywords', $keywords);
        $this->assign('description', $description);

        $this->assign('subMenu', $subMenu);
        $this->assign('image', $image);
        $this->assign('childCategoryList', $childCategoryList);
        $this->assign('articleList', $articleList);
        $this->assign('articleCategoryDetail', $articleCategoryDetail);
        $this->assign('sign', 'news');
        return $this->view->fetch();
    }

    // 文章详情
    public function detail($id=0)
    {
        $articleDetail = db('article')
            ->where('id', $id)
            ->find();

        // 查询模块
        $articleCategoryDetail = db('article_category')->where('id', $articleDetail['article_category_id'])->find();

        // 查询上级模块
        $parentArticleCategoryDetail= [];
        if(!empty($articleCategoryDetail['parent_id']))
        {
            $parentArticleCategoryDetail = db('article_category')->where('id', $articleCategoryDetail['parent_id'])->find();
        }

        $title= !empty($articleDetail['seo_title']) ? $articleDetail['seo_title'] : $this->site['seo_title'];
        $keywords = !empty($articleDetail['seo_keywords']) ? $articleDetail['seo_keywords'] : $this->site['seo_keywords'];
        $description = !empty($articleDetail['seo_description']) ? $articleDetail['seo_description'] : $this->site['seo_description'];
        $this->assign('title', $title);
        $this->assign('keywords', $keywords);
        $this->assign('description', $description);

        $this->assign('articleDetail', $articleDetail);
        $this->assign('articleCategoryDetail', $articleCategoryDetail);
        $this->assign('parentArticleCategoryDetail', $parentArticleCategoryDetail);
        $this->assign('sign', 'news');
        return $this->view->fetch();
    }

}